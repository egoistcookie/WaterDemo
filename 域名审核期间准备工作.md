# 域名审核期间准备工作清单

**域名**: www.egoistcookie.top  
**状态**: 管局审核中

## 一、代码准备工作（✅ 已完成）

### 1. 后端代码
- ✅ 豆包链接解析功能已实现（`backend/app.py`）
- ✅ Cookie管理功能已实现（`/api/doubao_cookie`）
- ✅ 图片代理功能已实现（`/api/image_proxy`）
- ✅ HTTPS支持已配置

### 2. 前端代码
- ✅ 豆包链接解析UI已集成
- ✅ Cookie输入功能已实现
- ✅ 图片代理显示已实现

## 二、配置准备工作（立即执行）

### 1. 更新小程序代码配置

**文件**: `pages/index/index.js`

```javascript
data: {
  // 将 apiBaseUrl 改为域名（等审核通过后启用）
  apiBaseUrl: 'https://www.egoistcookie.top'  // ✅ 改为你的域名
  
  // 暂时可以先用本地测试：
  // apiBaseUrl: 'http://127.0.0.1:5000'  // 本地开发用
}
```

### 2. 配置小程序域名白名单

**步骤**:
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** -> **开发管理** -> **开发设置** -> **服务器域名**
3. 在 **request合法域名** 中添加：
   ```
   https://www.egoistcookie.top
   ```
4. 在 **downloadFile合法域名** 中添加（如果直接下载图片）：
   ```
   https://www.egoistcookie.top
   ```

**注意**: 必须等域名审核通过并配置好HTTPS后才能添加！

### 3. 服务器HTTPS配置准备

#### 方案A：使用Let's Encrypt免费证书（推荐）

```bash
# 1. 安装Certbot
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

# 2. 等域名审核通过后，申请证书
sudo certbot --nginx -d www.egoistcookie.top

# 3. 自动续期（已自动配置）
sudo certbot renew --dry-run
```

#### 方案B：使用云服务商SSL证书（如阿里云）

1. 登录云服务商控制台
2. 申请免费SSL证书
3. 下载证书文件（Nginx格式）
4. 配置Nginx使用证书

详细步骤参考: `backend/HTTPS_SETUP.md`

## 三、部署准备工作

### 1. 服务器环境检查

```bash
# 检查Python版本（需要3.7+）
python3 --version

# 检查Nginx是否安装
nginx -v

# 检查端口占用
netstat -tlnp | grep :80
netstat -tlnp | grep :443
netstat -tlnp | grep :5000
```

### 2. 安装后端依赖

```bash
cd backend
pip3 install -r requirements-basic.txt

# 如果需要Playwright支持（可选）
pip3 install -r requirements-full.txt
playwright install chromium
```

### 3. 配置Nginx反向代理

创建配置文件: `/etc/nginx/sites-available/xhs-parser`

```nginx
server {
    listen 80;
    server_name www.egoistcookie.top;

    # 重定向HTTP到HTTPS（等配置好SSL后启用）
    # return 301 https://$server_name$request_uri;
    
    # 临时允许HTTP（等域名审核通过后改为HTTPS）
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# HTTPS配置（等SSL证书配置好后启用）
# server {
#     listen 443 ssl http2;
#     server_name www.egoistcookie.top;
# 
#     ssl_certificate /etc/letsencrypt/live/www.egoistcookie.top/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/www.egoistcookie.top/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
# 
#     location / {
#         proxy_pass http://127.0.0.1:5000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/xhs-parser /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

### 4. 配置后端服务（systemd）

创建服务文件: `/etc/systemd/system/xhs-parser.service`

```ini
[Unit]
Description=XHS Parser Backend Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/xhs-parser
Environment="PATH=/usr/bin:/usr/local/bin"
ExecStart=/usr/bin/python3 /opt/xhs-parser/app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable xhs-parser
sudo systemctl start xhs-parser
sudo systemctl status xhs-parser
```

## 四、本地测试工作

### 1. 测试后端API

```bash
# 启动本地服务
cd backend
python app.py

# 测试豆包解析（本地）
curl -X POST http://127.0.0.1:5000/api/parse \
  -H "Content-Type: application/json" \
  -d '{
    "short_link": "https://www.doubao.com/thread/w955a6c09897de89",
    "cookie": "你的豆包Cookie（可选）"
  }'
```

### 2. 测试小程序本地连接

1. 在小程序中输入短链测试
2. 检查日志输出
3. 测试图片加载

### 3. 测试Cookie管理

```bash
# 测试Cookie保存接口
curl -X POST http://127.0.0.1:5000/api/doubao_cookie \
  -H "Content-Type: application/json" \
  -d '{"cookie": "你的豆包Cookie"}'

# 返回 sid，用于后续图片代理请求
```

## 五、域名审核通过后的操作流程

### 1. 域名解析配置

在域名服务商（如阿里云）添加A记录：
```
主机记录: www
记录类型: A
记录值: 120.77.92.36（你的服务器IP）
TTL: 600
```

等待DNS生效（通常几分钟到几小时）：
```bash
# 检查DNS解析
nslookup www.egoistcookie.top
# 或
dig www.egoistcookie.top
```

### 2. 配置SSL证书

```bash
# 使用Certbot申请证书
sudo certbot --nginx -d www.egoistcookie.top

# 测试证书自动续期
sudo certbot renew --dry-run
```

### 3. 启用Nginx HTTPS配置

编辑 `/etc/nginx/sites-available/xhs-parser`，启用HTTPS配置，注释掉HTTP配置。

### 4. 更新小程序域名白名单

在微信公众平台添加域名到request合法域名列表。

### 5. 更新小程序代码

确保 `pages/index/index.js` 中的 `apiBaseUrl` 设置为：
```javascript
apiBaseUrl: 'https://www.egoistcookie.top'
```

### 6. 测试完整流程

1. 在小程序中输入豆包链接
2. 输入Cookie（可选）
3. 测试解析功能
4. 测试图片加载和下载

## 六、常见问题排查

### 1. 域名无法访问

```bash
# 检查DNS解析
nslookup www.egoistcookie.top

# 检查Nginx状态
sudo systemctl status nginx

# 检查后端服务
sudo systemctl status xhs-parser

# 检查防火墙
sudo ufw status
# 确保80和443端口开放
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

### 2. HTTPS证书问题

```bash
# 检查证书
sudo certbot certificates

# 手动续期
sudo certbot renew

# 检查证书文件权限
ls -la /etc/letsencrypt/live/www.egoistcookie.top/
```

### 3. 小程序网络请求失败

- 检查域名是否添加到小程序合法域名列表
- 检查是否使用HTTPS（HTTP会被拒绝）
- 检查服务器CORS配置

### 4. 豆包解析失败

- 检查Cookie是否有效
- 检查豆包链接格式是否正确
- 查看后端日志：`sudo journalctl -u xhs-parser -f`

## 七、安全注意事项

1. ✅ **必须使用HTTPS**：小程序不支持HTTP
2. ✅ **Cookie安全**：使用sid机制避免Cookie泄露
3. ✅ **CORS配置**：只允许小程序域名访问
4. ✅ **防火墙配置**：只开放必要端口
5. ✅ **日志管理**：定期清理日志文件

## 八、开发时间线

- [x] 代码开发完成
- [ ] 服务器环境配置
- [ ] 本地测试完成
- [ ] 等待域名审核通过
- [ ] DNS解析配置
- [ ] SSL证书配置
- [ ] Nginx配置完成
- [ ] 小程序域名白名单配置
- [ ] 完整流程测试
- [ ] 上线发布

## 九、快速检查清单

域名审核期间可以完成：
- [x] 代码已准备好
- [ ] 服务器环境配置完成
- [ ] Nginx配置文件准备好（HTTP版本）
- [ ] 后端服务配置完成
- [ ] 本地测试通过

域名审核通过后需要完成：
- [ ] DNS解析配置
- [ ] SSL证书申请和配置
- [ ] Nginx HTTPS配置启用
- [ ] 小程序域名白名单配置
- [ ] 完整功能测试

---

**提示**: 域名审核通常需要1-20个工作日，期间可以先完成服务器环境的配置和本地测试。
