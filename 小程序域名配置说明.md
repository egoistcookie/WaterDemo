# 小程序域名配置说明

## 问题描述

下载图片时出现错误：`downloadFile:fail url not in domairlist`

**原因**：图片URL使用了第三方CDN域名（如 `sns-webpic-qc.xhscdn.com`），这些域名没有在小程序后台配置为合法域名。

## 解决方案

### 方案1：使用后端代理（✅ 已实现，推荐）

**优点**：
- 只需要配置一个域名（你自己的后端域名）
- 不需要配置多个第三方CDN域名
- 统一管理，更安全

**实现**：
代码已修改，所有图片都会通过后端代理接口 `/api/image_proxy` 访问。

**配置步骤**：

1. **在小程序后台配置后端域名**

   登录 [微信公众平台](https://mp.weixin.qq.com/)
   - 进入 **开发** -> **开发管理** -> **开发设置** -> **服务器域名**
   - 在 **request合法域名** 中添加：
     ```
     https://www.egoistcookie.top
     ```
   - 在 **downloadFile合法域名** 中添加：
     ```
     https://www.egoistcookie.top
     ```

2. **确保后端服务正常运行**

   后端需要提供 `/api/image_proxy` 接口，代码中已实现。

3. **测试**

   现在所有图片都会通过 `https://www.egoistcookie.top/api/image_proxy?url=...` 访问，只需要配置这一个域名即可。

### 方案2：配置所有CDN域名（不推荐）

如果不想使用代理，需要在小程序后台配置所有可能的CDN域名：

**小红书CDN域名**：
```
https://sns-webpic-qc.xhscdn.com
https://sns-webpic-gc.xhscdn.com
https://sns-webpic-tc.xhscdn.com
https://sns-webpic-*.xhscdn.com  (通配符可能不支持)
```

**豆包CDN域名**：
```
https://*.byteimg.com
https://*.byteadapters.cn
https://*.doubaoimg.com
```

**缺点**：
- 需要配置很多域名
- 如果CDN域名变化，需要重新配置
- 维护成本高

## 当前代码实现

### 图片URL处理逻辑

```javascript
buildImageUrl(rawUrl, platform = '') {
  // 所有图片都通过后端代理
  const apiBaseUrl = this.data.apiBaseUrl || ''
  
  // 本地开发环境（HTTP）直接返回原始URL
  const isLocalHttp = apiBaseUrl.startsWith('http://127.0.0.1') || 
                      apiBaseUrl.startsWith('http://localhost')
  
  if (isLocalHttp) {
    // 本地开发：需要在开发工具中配置域名白名单
    return finalImageUrl
  }

  // 生产环境：所有图片都走代理
  const proxyUrl = `${proxyBase}/api/image_proxy?url=${encodeURIComponent(finalImageUrl)}`
  return proxyUrl
}
```

### 本地开发环境

如果使用本地开发（`http://127.0.0.1:5000`），图片会直接使用原始URL，需要在微信开发者工具中配置：

1. 打开微信开发者工具
2. 右上角 **详情** -> **本地设置**
3. 勾选 **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**

**注意**：这只是开发环境，正式发布前必须配置正确的域名。

## 配置检查清单

- [ ] 后端服务已部署并配置HTTPS
- [ ] 域名 `www.egoistcookie.top` 已在小程序后台配置为 **request合法域名**
- [ ] 域名 `www.egoistcookie.top` 已在小程序后台配置为 **downloadFile合法域名**
- [ ] 小程序代码中的 `apiBaseUrl` 已设置为 `https://www.egoistcookie.top`
- [ ] 后端 `/api/image_proxy` 接口正常工作
- [ ] 测试图片显示和下载功能

## 测试步骤

1. **测试图片显示**
   - 解析一个短链
   - 检查图片是否能正常显示
   - 查看控制台，确认图片URL是通过代理访问的

2. **测试图片下载**
   - 选择一张图片
   - 点击下载
   - 确认能成功下载到相册

3. **查看日志**
   - 如果下载失败，查看控制台日志
   - 检查错误信息

## 常见问题

### Q1: 本地开发时图片无法显示/下载

**A**: 本地开发环境使用HTTP，无法使用代理。有两个选择：
1. 在开发者工具中勾选"不校验合法域名"（仅开发环境）
2. 配置本地HTTPS（较复杂）

### Q2: 生产环境图片仍然无法下载

**A**: 检查：
1. 域名是否已在小程序后台配置
2. 后端服务是否正常运行
3. 后端是否支持HTTPS
4. 查看后端日志，确认代理请求是否成功

### Q3: 代理请求返回403

**A**: 可能是：
1. 目标图片URL需要特定的请求头（如Referer）
2. 目标图片URL需要Cookie（如豆包无水印图片）
3. 检查后端 `image_proxy` 接口的请求头配置

## 后端代理接口说明

**接口**: `GET /api/image_proxy`

**参数**:
- `url`: 目标图片URL（需要URL编码）

**示例**:
```
GET https://www.egoistcookie.top/api/image_proxy?url=https%3A%2F%2Fsns-webpic-qc.xhscdn.com%2Fxxx.jpg
```

**响应**: 返回图片二进制数据，Content-Type为图片类型

**实现**: 后端代码 `backend/app.py` 中已实现
