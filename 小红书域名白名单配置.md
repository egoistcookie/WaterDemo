# 小红书CDN域名白名单配置

## 需要添加到微信小程序后台的域名

### downloadFile合法域名（必须添加）

在小程序后台 **开发** -> **开发管理** -> **开发设置** -> **服务器域名** -> **downloadFile合法域名** 中添加以下域名：

```
https://sns-webpic-qc.xhscdn.com
https://sns-webpic-gc.xhscdn.com
https://sns-webpic-tc.xhscdn.com
https://sns-webpic-*.xhscdn.com
https://xhscdn.com
https://*.xhscdn.com
```

**注意**：微信小程序可能不支持通配符域名（`*.xhscdn.com`），如果支持通配符就添加通配符，如果不支持，需要添加所有可能的子域名。

### 常见的小红书CDN子域名

如果通配符不支持，需要添加以下具体域名：

```
https://sns-webpic-qc.xhscdn.com
https://sns-webpic-gc.xhscdn.com
https://sns-webpic-tc.xhscdn.com
https://sns-webpic-*.xhscdn.com（如果支持通配符）
```

### request合法域名（如果需要）

如果图片显示也需要通过request请求，还需要在 **request合法域名** 中添加：

```
https://sns-webpic-qc.xhscdn.com
https://sns-webpic-gc.xhscdn.com
https://sns-webpic-tc.xhscdn.com
https://*.xhscdn.com（如果支持）
```

## 配置步骤

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** -> **开发管理** -> **开发设置** -> **服务器域名**
3. 在 **downloadFile合法域名** 中添加上述域名
4. 保存配置
5. 等待配置生效（通常几分钟内生效）

## 代码修改说明

代码已修改为使用原始URL下载图片，不再使用代理URL。

**文件**: `pages/index/index.js`

**修改内容**:
```javascript
// 下载也用原始URL（暂时）
const downloadUrl = this.buildImageUrl(raw, platform, false)
```

## 注意事项

1. **域名必须使用HTTPS**：微信小程序不支持HTTP协议
2. **通配符支持**：微信小程序可能不支持通配符域名，如果不支持，需要添加所有可能的子域名
3. **配置生效时间**：配置后通常几分钟内生效，如果立即测试失败，请稍等片刻
4. **域名数量限制**：微信小程序对合法域名数量有限制，如果域名太多，建议使用后端代理方案

## 如果域名太多无法全部添加

如果小红书使用了太多不同的CDN子域名，无法全部添加到白名单，可以考虑：

1. **使用后端代理**（推荐）：
   - 部署后端服务
   - 使用 `/api/image_proxy` 接口代理图片
   - 只需要配置一个后端域名

2. **动态域名检测**：
   - 解析短链后，提取所有图片URL的域名
   - 提示用户需要添加哪些域名

## 测试

配置完成后，测试步骤：

1. 解析一个小红书短链
2. 查看图片是否能正常显示
3. 点击下载，确认能成功保存到相册
4. 如果失败，查看控制台日志，确认是哪个域名的问题

## 常见问题

### Q: 添加域名后仍然无法下载

**A**: 
1. 检查域名是否正确（必须包含 `https://`）
2. 等待几分钟让配置生效
3. 检查图片URL是否使用了其他未添加的域名
4. 查看控制台错误信息

### Q: 支持通配符吗？

**A**: 微信小程序可能不支持通配符，建议先尝试添加通配符，如果不行再添加具体域名。

### Q: 域名数量有限制吗？

**A**: 是的，微信小程序对合法域名数量有限制。如果域名太多，建议使用后端代理方案。
